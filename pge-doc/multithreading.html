<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.12.0"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>PGE API: Multithreading</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="clipboard.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="cookie.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="pure_doxystyle.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">PGE API<span id="projectnumber">&#160;0.4</span>
   </div>
   <div id="projectbrief">PR00F&#39;s Game Engine full documentation</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.12.0 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() { codefold.init(0); });
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search',true);
  $(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){initNavTree('multithreading.html',''); initResizable(true); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Multithreading</div></div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul>
  <li class="level1">
    <a href="#multithreading_windows">Tools for Windows</a>
  </li>
  <li class="level1">
    <a href="#multithreading_valgrind">Valgrind</a>
    <ul>
      <li class="level2">
        <a href="#multithreading_valgrind_memcheck">Memory Check</a>
      </li>
      <li class="level2">
        <a href="#multithreading_valgrind_helgrind">Helgrind Thread Checker</a>
      </li>
      <li class="level2">
        <a href="#multithreading_valgrind_drd">DRD Thread Checker</a>
      </li>
      <li class="level2">
        <a href="#multithreading_valgrind_further">Further Info</a>
      </li>
    </ul>
  </li>
</ul>
</div>
<div class="textblock"><p>Note that anytime you want to use any of the tools mentioned on this page, it is highly recommended to make a <b>debug build</b> of your application you want to check.</p>
<p>Summary of why we need mutexes or atomic variables to serialize access to shared variables: <br  />
 Variables accessed from different threads concurrently can lead to undefined behavior. <br  />
 Due to possible compiler optimization, CPU out-of-order execution, or caching, the behavior of the program might be different than expected. <br  />
 Example: <br  />
 thread A executed by 1 CPU core changes such variable, but thread B executed by another CPU core will never see the change because it has its cached version of that variable (even thread A might just update the variable in cache, not even in operational memory, or even if it updates in operational memory, thread B might just don't update its cache from the operational memory). <br  />
 Solution: <br  />
 C++11 has atomic variables which get rid of this problem by using memory fences/barriers. The effect is similar to using mutex to protect such variables. <br  />
 And lastly: using "volatile" keyword is simple not enough. <br  />
 See URLs for more info: <br  />
 <a href="https://stackoverflow.com/questions/8819095/concurrency-atomic-and-volatile-in-c11-memory-model">https://stackoverflow.com/questions/8819095/concurrency-atomic-and-volatile-in-c11-memory-model</a> <br  />
 <a href="https://stackoverflow.com/questions/28738028/can-mutex-replace-memory-barriers">https://stackoverflow.com/questions/28738028/can-mutex-replace-memory-barriers</a></p>
<h1><a class="anchor" id="multithreading_windows"></a>
Tools for Windows</h1>
<p>Unfortunately, Valgrind is not available for Windows. <br  />
 However, there are multiple tools for checking thread behavior for Windows.</p>
<p>There is an official extension for VS2022, <b>Concurrency Visualizer</b>: <br  />
 <a href="https://marketplace.visualstudio.com/items?itemName=Diagnostics.DiagnosticsConcurrencyVisualizer2022#overview">https://marketplace.visualstudio.com/items?itemName=Diagnostics.DiagnosticsConcurrencyVisualizer2022#overview</a> <br  />
 <a href="https://docs.microsoft.com/en-us/visualstudio/profiling/common-patterns-for-poorly-behaved-multithreaded-applications?view=vs-2022">https://docs.microsoft.com/en-us/visualstudio/profiling/common-patterns-for-poorly-behaved-multithreaded-applications?view=vs-2022</a></p>
<p><b>Intel Inspector</b> can pinpoint data race, memory leak, etc: <br  />
 <a href="https://www.intel.com/content/www/us/en/developer/articles/tool/oneapi-standalone-components.html#inspector">https://www.intel.com/content/www/us/en/developer/articles/tool/oneapi-standalone-components.html#inspector</a> <br  />
 <a href="https://www.intel.com/content/www/us/en/developer/tools/oneapi/inspector.html#gs.8v7hpe">https://www.intel.com/content/www/us/en/developer/tools/oneapi/inspector.html#gs.8v7hpe</a></p>
<p>And also in Windows SDK, there is the <b>Application Verifier</b>: <br  />
 <a href="https://docs.microsoft.com/en-us/windows-hardware/drivers/devtest/application-verifier#installing-appverifier">https://docs.microsoft.com/en-us/windows-hardware/drivers/devtest/application-verifier#installing-appverifier</a> <br  />
 I'm not sure if I managed to use this tool properly though because it always generated no errors or warnings during checking my application even when I intentionally made some threading mistake. <br  />
 Don't forget that some exceptions are expected to be thrown when this tool is enabled, you need to set your debugger to handle those as second-chance, as described here: <br  />
 <a href="https://docs.microsoft.com/en-us/windows-hardware/drivers/devtest/application-verifier-debugging-application-verifier-stops">https://docs.microsoft.com/en-us/windows-hardware/drivers/devtest/application-verifier-debugging-application-verifier-stops</a></p>
<h1><a class="anchor" id="multithreading_valgrind"></a>
Valgrind</h1>
<p>Valgrind is my favourite tool to check thread related issues under Linux (and it is also useful for memory leak/corruption check). <br  />
 Understanding the output of Valgrind is not topic of this page. <br  />
 Read the <a href="https://valgrind.org/docs/manual/QuickStart.html" target="_blank">QuickStart Guide</a> and the <a href="https://valgrind.org/docs/manual/manual.html" target="_blank">Manual</a>.</p>
<h2><a class="anchor" id="multithreading_valgrind_memcheck"></a>
Memory Check</h2>
<p>Example use for memory leak or corruption checking: </p><div class="fragment"><div class="line">valgrind --tool=memcheck --leak-check=full --leak-check-heuristics=all --trace-children=yes --track-origins=yes -s &lt;binary_path&gt;</div>
</div><!-- fragment --><p><b>Suppression File</b> <br  />
 If you see some irrelevant complains, like about some conditional jumps based on uninitialized variables within a linux ld lib, you can add such irrelevant complains to suppression file. <br  />
 To ask valgrind to generate suppressions for you based on the detected errors, run it with adding <b>&ndash;gen-suppressions=all</b> option, and then you can copy those suppressions into a suppression file. <br  />
 And then you can simply re-run Valgrind using that suppression file by adding the <b>&ndash;suppressions=yourSuppressionFile.supp</b> option.</p>
<p><b>In Case of Problem Related to strlen() or index()</b> <br  />
 However, when I ran it, it displayed complain about not finding strlen() function in the host machine's ld-linux.so.2 file. This is mandatory for the memcheck tool. <br  />
 Although it recommended adding glibc-debuginfo module as a short-term solution, it didn't help me!</p>
<p><b>Workaround</b> <br  />
 I google'd around and understood this problem is present for like ~10 years already. <br  />
 If you can install packages then do that as explained on the internet. <br  />
 However, I was working on some machine where I was not allowed to install any package, so I had to rebuild Valgrind with a patch. <br  />
 This patch was made by someone who uploaded it to the internet: <br  />
 <a href="https://bugsfiles.kde.org/attachment.cgi?id=82043">https://bugsfiles.kde.org/attachment.cgi?id=82043</a> <br  />
 This patch disables the check for strlen() presence in the abovementioned shared libraries.</p>
<p>For better understanding the problem, you can read the comments in the bugreport:   <a href="https://bugs.kde.org/show_bug.cgi?id=286864">https://bugs.kde.org/show_bug.cgi?id=286864</a></p>
<p>To apply the patch, obviously we need to download and build Valgrind with the patch.</p>
<p><b>Download Valgrind</b> <br  />
 Official site of Valgrind is this:  <a href="https://valgrind.org/downloads/repository.html">https://valgrind.org/downloads/repository.html</a></p>
<p>It tells you that source code can be cloned like: </p><div class="fragment"><div class="line">git clone git://sourceware.org/git/valgrind.git</div>
</div><!-- fragment --><p>The problem is that it simply timed out for me, maybe because of some firewall setting with that computer I tried it on. <br  />
 You can try alternate git server as stated on the site.</p>
<p>So I rather downloaded it from the official site as a package:  <a href="https://valgrind.org/downloads/current.html">https://valgrind.org/downloads/current.html</a></p>
<p><b>Applying the Patch</b> <br  />
 You can download the patch and patch with the linux patch command and hope it is still compatible with the source code you've downloaded, or edit the coregrind/m_redir.c file manually as the patch would do. I did the latter.</p>
<p>Hint: not only the strlen() check but also the index() check should be also disabled! So edit the source code with this in mind!</p>
<p>Hint: I've noticed that in the latest version of Valgrind there is already a macro controlling this, if you look closely at the source code you will see it anyway!</p>
<p><b>Building Valgrind</b> <br  />
 Now you need to follow the instructions as stated on the official site or in the README file:</p>
<div class="fragment"><div class="line">cd valgrind-3.18.1</div>
<div class="line">./autogen.sh</div>
<div class="line">./configure --prefix=&lt;PUT THE DIRECTORY WHERE YOU WANT TO BUILD YOUR CUSTOM VALGRIND&gt;</div>
<div class="line">make</div>
<div class="line">make install</div>
</div><!-- fragment --><h2><a class="anchor" id="multithreading_valgrind_helgrind"></a>
Helgrind Thread Checker</h2>
<p>To debug threading related issues, the helgrind tool can be used, like: </p><div class="fragment"><div class="line">valgrind --tool=helgrind --trace-children=yes --read-var-info=yes -s &lt;binary_path&gt;</div>
</div><!-- fragment --><h2><a class="anchor" id="multithreading_valgrind_drd"></a>
DRD Thread Checker</h2>
<p>This is also a Valgrind tool, to debug threading related issues: </p><div class="fragment"><div class="line">valgrind --tool=drd --read-var-info=yes -s &lt;binary_path&gt;</div>
</div><!-- fragment --><h2><a class="anchor" id="multithreading_valgrind_further"></a>
Further Info</h2>
<p>Note that in some cases, Helgrind may show wrong errors if you use C++11 condition variables. <br  />
 Such wrong errors can be displayed as: <br  />
 either like "mutex is locked simultaneously by two threads" <br  />
 or like "Thread ... unlocked lock at ... currently held by thread ...". <br  />
 To solve this issue, you need to <a href="https://bugsfiles.kde.org/attachment.cgi?id=143599" target="_blank">apply patch not yet officially released</a>. <br  />
 <a href="https://www.mail-archive.com/kde-bugs-dist@kde.org/msg622117.html" target="_blank">This is the related discussion</a>, and <a href="https://bugs.kde.org/show_bug.cgi?id=445504" target="_blank">this is the ticket for it</a>.</p>
<p>Also it is good to know that proper behavior for Helgrind or DRD or even <a href="https://github.com/google/sanitizers/wiki/ThreadSanitizerCppManual" target="_blank">ThreadSanitizer</a> requires 2 macros to be defined properly: <br  />
 **_GLIBCXX_SYNCHRONIZATION_HAPPENS_BEFORE** <br  />
 **_GLIBCXX_SYNCHRONIZATION_HAPPENS_AFTER** <br  />
 Details can be found in the manual of the tools, you can also <a href="https://gcc.gnu.org/onlinedocs/libstdc++/manual/debug.html" target="_blank">read about it here</a>, in the "Data Race Hunting" section. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.12.0 </li>
  </ul>
</div>
</body>
</html>
